# LilsMusic
`Simple, Beautiful Music App` <br>
<br>

## ğŸ“±ìŠ¤í¬ë¦°ìƒ·
<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/137d699f-695e-4e8c-9f30-89480a32b375" width="150"></img>
<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/5fd3b214-5672-47c6-8118-11b7f92a78c9" width="150"></img>
<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/5730a407-8cc6-4f88-a066-296e2cf3fcb3" width="150"></img>
<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/7f31beab-e393-435a-a396-cd27827d6ff4" width="150"></img>
<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/5564fdd2-1aa4-40e7-b213-91b52c561280" width="150"></img>

## ğŸ”— Links
### [ğŸ“±Â AppStore](https://apps.apple.com/app/lilsmusic/id6480001911)
### [ğŸ§‘ğŸ»â€ğŸ’»Â Blog](https://thekoon0456.tistory.com/search/lils)
<br>

## ğŸ“Œ ì£¼ìš” ê¸°ëŠ¥
- ìµœì‹  ì¸ê¸° ìŒì•…ê³¼ ê°œì¸í™”ëœ ì¶”ì²œ ìŒì•… ì œê³µ
- ìŒì•… ì¬ìƒ, ìŒì•… ê²€ìƒ‰, í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
- ìµœì‹  ë®¤ì§ë¹„ë””ì˜¤ë¥¼ ë³´ë©° ì¢‹ì€ ë…¸ë˜ë¥¼ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì €ì¥
- í¸ë¦¬í•œ í”Œë¡œíŒ… ë¯¸ë‹ˆ ë®¤ì§ í”Œë ˆì´ì–´
- ë‹¤ì–‘í•œ ì• ë‹ˆë©”ì´ì…˜ê³¼ í–…í‹± ë°˜ì‘
<br>

## ê¸°ìˆ  ìŠ¤íƒ
- UIKit, MVVM-C, Input-Output, Singleton, Repository, CodeBasedUI
- RxSwift, SwiftConcurrency
- MusicKit, AVFoundation, AVKit, Realm
- Compositional Layout, CollectionViewPagingLayout, DiffableDataSource,
- Kingfisher, SnapKit
- Firebase(Analytics, Crashlytics)
<br>

## ğŸ“±ì‹œì—° ì˜ìƒ
|<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/cb2ceb18-776c-460c-b5dc-9ea4cbcbe82d" width="200"></img>|<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/967715c2-63cb-4ab7-87c8-d65c09dda3a0" width="200"></img>|<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/5a8338c5-1f49-4f16-b71d-b7bdd1d140ad" width="200"></img>|<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/4c7ff5d9-bb76-48f6-b1df-e1d0d7c56b44" width="200"></img>|
|:-:|:-:|:-:|:-:|
|`ìŒì•… í”Œë ˆì´ì–´`|`ë®¤ì§ë¹„ë””ì˜¤`|`ë¯¸ë‹ˆ í”Œë ˆì´ì–´`|`ë¼ì´ë¸ŒëŸ¬ë¦¬`|
|<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/16848413-a69e-4322-9687-6a06b43c9d7d" width="200"></img>|<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/dd07a402-1764-45e5-bf78-5ef3dee0e1f1" width="200"></img>|<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/41c368bd-4ee6-476e-8ca0-8b5e10a4c10b" width="200"></img>|<img src="https://github.com/thekoon0456/LilsMusic/assets/106993057/d1b98bdb-ef1c-4181-ba7c-ebe83df1a042" width="200"></img>|
|`í™ˆ í™”ë©´`|`ìŒì•… ê²€ìƒ‰`|`ê¶Œí•œ ì„¤ì •`|`êµ¬ë… ì œì•ˆ`|
<br>

## ğŸ’» ì•± ê°œë°œ í™˜ê²½

- ìµœì†Œ ì§€ì› ë²„ì „: iOS 16.4+
- Xcode Version 15.0.0
- iPhone SE3 ~ iPhone 15 Pro Max ì „ ê¸°ì¢… í˜¸í™˜ ê°€ëŠ¥
<br>

## ğŸ’¡ ê¸°ìˆ  ì†Œê°œ

### MVVM
- ì‚¬ìš©ì ì…ë ¥ ë° ë·°ì˜ ë¡œì§ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ì— ê´€ë ¨ëœ ë¡œì§ì„ ë¶„ë¦¬í•˜ê¸° ìœ„í•´ MVVMì„ ë„ì…
- Input, Output íŒ¨í„´ì„ í™œìš©í•´ ë°ì´í„°ì˜ íë¦„ì„ ì „ë‹¬ë°›ì„ ê°’ê³¼, ì „ë‹¬í•  ê°’ì„ ëª…í™•í•˜ê²Œ ë‚˜ëˆ„ê³  ê´€ë¦¬
- ViewModel Protocolì„ í™œìš©í•´ êµ¬ì¡°ì ìœ¼ë¡œ ì¼ê´€ëœ ë·°ëª¨ë¸ êµ¬ì„±
<br>

### Coordinator íŒ¨í„´
- ì‚¬ìš©ì ì¸ì¦ í™”ë©´, ìŒì•… í”Œë ˆì´ì–´ ì¬ìƒ í™”ë©´ë“± í™”ë©´ ì „í™˜ ì½”ë“œê°€ ë³µì¡í•´ì§€ê³  ë¹„ëŒ€í•´ì§€ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë·° ì»¨íŠ¸ë¡¤ëŸ¬ì™€ í™”ë©´ ì „í™˜ ë¡œì§ì„ ë¶„ë¦¬
- Coordinator ìƒì„±, ViewModel ìƒì„±, ViewController ìƒì„±í•˜ëŠ” íŒ¨í„´ìœ¼ë¡œ ì˜ì¡´ì„± ì£¼ì…
- ViewControllerì˜ Inputì´ ViewModelì˜ Coordinatorë¡œ ì „ë‹¬í•˜ì—¬ í™”ë©´ ì „í™˜
<br>

### RxSwift
- ìŒì•… ì•±ì˜ íŠ¹ì„±ìƒ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ë§ê³ , ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‘ë™í•˜ê¸° ë•Œë¬¸ì— ë¹„ë™ê¸° ì²˜ë¦¬ì™€ Thread ê´€ë¦¬ê°€ ì¤‘ìš”
- RxSwiftë¥¼ í™œìš©í•´ ì•± ë‚´ì˜ ì¼ê´€ì„± ìˆëŠ” ë¹„ë™ê¸° ì²˜ë¦¬ì™€ Traitsë¥¼ í™œìš©í•˜ì—¬ Thread ê´€ë¦¬
<br>

### MusicKit
- Appleì˜ MusicKit í”„ë ˆì„ì›Œí¬ë¥¼ í™œìš©í•´ ìŒì•… í”Œë ˆì´ì–´ êµ¬í˜„
- SwiftUIì˜ í”„ë ˆì„ì›Œí¬ì¸ MusicKitì„ UIKitì— ìµœì í™”í•˜ì—¬ êµ¬í˜„

<br>

### AVFoundation, AVKit
- ë®¤ì§ë¹„ë””ì˜¤ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìŠ¤íŠ¸ë§í•˜ë©°, ì¢‹ì€ ë…¸ë˜ë¥¼ ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ AVPlayer ì‚¬ìš©
- AVQueuePlayerì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ì‚¬ìš©í–ˆì§€ë§Œ, ì‚¬ìš©ìê°€ Cellì„ ë„˜ê¸¸ë•Œë§ˆë‹¤ ì¬ìƒì´ ì‹œì‘ë˜ë¯€ë¡œ í•„ì—°ì ìœ¼ë¡œ ë”œë ˆì´ ë°œìƒ
- ê° Cellë§ˆë‹¤ AVPlayer ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒìƒí•˜ê³ , cellì´ configureë ë•Œ ë¯¸ë¦¬ ì¬ìƒí•˜ë„ë¡ ì„¤ì •í•´ì„œ ë”œë ˆì´ë¥¼ ì¤„ì´ê³  ì¬ìƒ ìµœì í™”
- observeValue() í•¨ìˆ˜ë¥¼ í†µí•´ AVPlayerì˜ ìƒíƒœë¥¼ ì˜µì €ë¹™í•˜ê³ , ë¡œë”© ì¤€ë¹„ ì™„ë£Œì‹œì— ë¡œë”© ì¸ë””ì¼€ì´í„° í•´ì œ
<br>

### SwiftConcurrency
- ìµœì‹  APIì¸ MusicKitì˜ async/await í•¨ìˆ˜ í™œìš©
- MusicKitì˜ SwiftConcurrency APIì™€ Combine APIë¥¼ RxSwiftì˜ flatmapì„ í™œìš©í•´ ì¼ê´€ëœ ë¹„ë™ê¸°ì²˜ë¦¬ì™€ Thread ê´€ë¦¬
<br>

### ModernCollectionView
- ì¶”ì²œí™”ë©´ì˜ 4ê°€ì§€ì˜ ë‹¤ë¥¸ Layoutì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ UICollectionView CompositionalLayoutí™œìš©
- MusicVideoíƒ­ì˜ Cellì´ í™”ë©´ì„ ê°€ë“ ì±„ìš°ê³ , í˜ì´ì§• ìŠ¤í¬ë¡¤ êµ¬í˜„
- List í™”ë©´ì—ì„œ Item ë¡œë“œì‹œ ì• ë‹ˆë©”ì´ì…˜ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ UICollectionView CompositionalLayoutì˜ List í™œìš©
- ë‹¤ì–‘í•œ ë ˆì´ì•„ì›ƒì„ ëŒ€ì‘í•˜ê³ , ë¡œë”©ì‹œ ì• ë‹ˆë©”ì´ì…˜ êµ¬í˜„
<br>

### Realm
- Repository íŒ¨í„´ì„ ì‚¬ìš©í•´ ë°ì´í„° ê³„ì¸µ ì¶”ìƒí™”
- Repository Protocolì„ í™œìš©í•´ ì¼ê´€ì„±ìˆëŠ” Repository êµ¬ì¡° êµ¬í˜„
- ì—…ë°ì´íŠ¸ ë‚´ì—­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜í•˜ê¸° ìœ„í•´ notificationToken ì‚¬ìš© 
- ë°ì´í„° ê´€ë¦¬ë¥¼ ì¼ê´€ì„±ìˆê²Œ ìœ ì§€í•˜ë©°, ë³€ê²½ì‚¬í•­ì´ ë°œìƒí• ë•Œë§ˆë‹¤ UIë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„
<br>

## âœ… íŠ¸ëŸ¬ë¸” ìŠˆíŒ…
### ë®¤ì§ë¹„ë””ì˜¤ë¥¼ AVPlayerë¡œ ì¬ìƒì‹œì— cellì„ ë„˜ê¸¸ë•Œë§ˆë‹¤ UIFreezingì´ ë°œìƒí•˜ëŠ” ë¬¸ì œ
<div markdown="1">
MusicVideo ë¦´ìŠ¤ íƒ­ì—ì„œ Cellì„ ë„˜ê¸¸ë•Œë§ˆë‹¤ MusicVideoì˜ ë¡œë”©ìœ¼ë¡œ ì¸í•´ UIFreezingì´ ë°œìƒí•˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤.<br>
ê¸°ì¡´ì—ëŠ” AVQueuePlayerì— ì¬ìƒí•  URLë“¤ì„ Queueì— ë„£ì€ ë’¤ì— cellì„ ë„˜ê¸¸ë•Œë§ˆë‹¤ í•˜ë‚˜í•˜ë‚˜ ìš”ì²­í•´ì„œ ì¬ìƒí–ˆì§€ë§Œ<br>
UIFreezing ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ ì, ê° Cellë§ˆë‹¤ configureì‹œì ì— URLì„ ë„£ê³ , ì¼ì‹œì •ì§€ ì‹œí‚¨ ë’¤<br>
Cellì´ í™”ë©´ì— ë³´ì¼ë•Œ ì¬ìƒí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë”œë ˆì´ë¥¼ ì¤„ì˜€ìŠµë‹ˆë‹¤.<br>
<br>

```swift
//ReelsCell
//cellì„ êµ¬ì„±í• ë•Œ AVPlayerì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ Cellë§ˆë‹¤ ê°ê° ìƒì„±í•˜ê³ , URLì„ ë„£ê³  ì¼ì‹œì •ì§€ ìƒíƒœë¡œ ëŒ€ê¸°ì‹œí‚´
    func configureCell(_ data: MusicVideo, status: AVPlayer.TimeControlStatus) {
        //cellì¬ì‚¬ìš©í• ë•Œ bind
        bind()
        mvSubject.onNext(data)
        
        guard let url = data.previewAssets?.first?.hlsURL else { return }
        let asset = AVURLAsset(url: url)
        
        DispatchQueue.main.async { [weak self] in
            guard let self else { return }
            DisplayVideoFromAssets(asset: asset, view: musicVideoView)
            setPlayerStatus(status: status)
        }
        ...
    }

    //ë¡œë”© ì¸ë””ì¼€ì´í„°ì™€ ì¬ìƒ ì™„ë£Œì‹œ ë°˜ë³µí•˜ëŠ” Noficifation ìƒì„±
    func DisplayVideoFromAssets(asset: AVURLAsset, view: UIView) {
        startLoadingIndicator()
        
        let playerItem = AVPlayerItem(asset: asset)
        playerItem.addObserver(self, forKeyPath: "status", options: [.new, .old], context: nil)
        player = AVPlayer(playerItem: playerItem).then {
            $0.isMuted = true
        }
        
        let playerLayer = AVPlayerLayer(player: player)
        ...
        
        NotificationCenter.default.addObserver(forName: .AVPlayerItemDidPlayToEndTime,
                                               object: player?.currentItem,
                                               queue: .main) { [weak self] _ in
            guard let self else { return }
            player?.seek(to: .zero)
            player?.play()
        }
    }

    //AVPlayerì˜ ìƒíƒœë¥¼ ì¶”ì í•˜ê³ , readyToPlayì‹œì ì—ì„œ ë¡œë”©ì¸ë””ì¼€ì´í„° í•´ì œ
    override func observeValue(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?) {
        if keyPath == "status" {
            if let playerItem = object as? AVPlayerItem {
                switch playerItem.status {
                case .readyToPlay:
                    stopLoadingIndicator()
                case .failed, .unknown:
                    print("Failed to load the video")
                @unknown default:
                    break
                }
            }
        }
    }
```
</div>
<br>

### Coordinatorë¥¼ í™œìš©í•´ ì• í”Œë®¤ì§ ê¶Œí•œ ìš”ì²­ê³¼ ì‚¬ìš©ìì˜ êµ¬ë… ê¶Œì¥ê¹Œì§€ì˜ íë¦„ ì²˜ë¦¬
<div markdown="1">

ì• í”Œë®¤ì§ì„ ì•±ê³¼ ì—°ë™í•˜ê¸° ìœ„í•´ì„œëŠ” ì• í”Œë®¤ì§ ê¶Œí•œ ìš”ì²­ê³¼, ì• í”Œë®¤ì§ êµ¬ë…ì„ í™•ì¸í•˜ëŠ” ê³¼ì •ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤.<br>
1. ì• í”Œë®¤ì§ ê¶Œí•œì„ ìš”ì²­í•˜ë©´
    - ê¶Œí•œ ê±°ë¶€ì‹œ ì•„ì´í°ì˜ ì•± ê¶Œí•œ ì„¤ì • í™”ë©´ìœ¼ë¡œ ì´ë™í•´ ê¶Œí•œ ìˆ˜ì • ìš”ì²­<br>
    - ê¶Œí•œ ìŠ¹ì¸ì‹œ ì•± ì‚¬ìš©. ì¬ìƒë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì• í”Œë®¤ì§ êµ¬ë… í™•ì¸<br>
2. ì• í”Œë®¤ì§ êµ¬ë… í™•ì¸ í›„
    - êµ¬ë…ìë¼ë©´ ë…¸ë˜ ì¬ìƒ. êµ¬ë…ì ì¶”ì²œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°<br>
    - êµ¬ë…ìê°€ ì•„ë‹ˆë¼ë©´ êµ¬ë… ì œì•ˆ í™”ë©´ì„ Presentí•˜ëŠ” ë³µì¡í•œ ë¶„ê¸°ì²˜ë¦¬ë¥¼ Coordinatorë¥¼ í†µí•´ í•´ê²°í–ˆìŠµë‹ˆë‹¤.<br>
<br>

```swift
//StoreKitì„ í™œìš©í•´ êµ¬ë… ê´€ë¦¬
//SubscriptionManager
    func checkAppleMusicSubscriptionEligibility(completion: @escaping (Bool) -> Void) {
        let controller = SKCloudServiceController()
        
        controller.requestCapabilities { capabilities, error in
            if let error {
                print(error.localizedDescription)
                return
            }
            
            if capabilities.contains(.musicCatalogSubscriptionEligible) && !capabilities.contains(.musicCatalogPlayback) {
                completion(false)
                return
            } else {
                completion(true)
                return
            }
        }
    }

//ì•± ì§„ì…ì‹œ UserDefaultsì— êµ¬ë…ì—¬ë¶€ ì €ì¥
//SceneDelegate
    func sceneWillEnterForeground(_ scene: UIScene) {
        SubscriptionManager.shared.checkAppleMusicSubscriptionEligibility { bool in
            print("ìœ ì € êµ¬ë…\(bool)")
            UserDefaultsManager.shared.userSubscription.isSubscribe = bool
        }
    }

//ë…¸ë˜ ì¬ìƒì‹œ êµ¬ë…ì—¬ë¶€ì— ë”°ë¼ êµ¬ë…ì œì•ˆ í˜¹ì€ ìŒì•… í”Œë ˆì´ì–´ present
//MusicListViewModel
        input.playButtonTapped
            .withUnretained(self)
            .subscribe { owner, _ in
                owner.tapImpact()
                Task {
                    guard let tracks = try await owner.fetchTracks(),
                          let firstItem = tracks.first else { return }
                    await owner.musicPlayer.setTrackQueue(item: tracks, startTrack: firstItem)
                    DispatchQueue.main.async {
                        owner.isUserSubscription
                        ? owner.coordinator?.presentMusicPlayer(track: firstItem)
                        : owner.coordinator?.presentAppleMusicSubscriptionOffer()
                    }
                }
            }.disposed(by: disposeBag)
```
</div>
<br>

### Swift Concurrency, Combineê³¼ RxSwiftë¥¼ í•¨ê»˜ ì—°ë™í•˜ë©° ìŠ¤ë ˆë“œ, ë¹„ë™ê¸° ì‹œì  ë¬¸ì œ
<div markdown="1">
MusicKitì€ SwiftUIë¥¼ ëŒ€ìƒìœ¼ë¡œ ë§Œë“  ìµœì‹  í”„ë ˆì„ìœ„í¬ì´ê¸° ë•Œë¬¸ì—<br>
ê¸°ì¡´ UIKitì˜ CompletionHandlerì™€ NotificationCenterê°€ ì•„ë‹Œ SwiftConcurrencyì™€ Combine APIë¥¼ ì œê³µí•´ì£¼ì—ˆëŠ”ë°<br>
RxSwiftì˜ Schedulerì™€ SwiftConcurrencyì˜ Taskê°„ì˜ ì¶©ëŒì´ ìˆì—ˆìŠµë‹ˆë‹¤.<br>
ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ RxSwiftì˜ flatMapLatestí•¨ìˆ˜ë¥¼ í™œìš©í•´ Taskë¡œ ë°˜í™˜í•œ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í•œë²ˆ Observableë¡œ ë§¤í•‘í•˜ì—¬<br>
RxSwiftì˜ Schedulerì™€ ì—°ë™í•´ ì¼ê´€ì„±ìˆëŠ” Threadê´€ë¦¬ë¥¼ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.<br>
<br>

```swift
//FMMusicPlayer
let currentEntrySubject = BehaviorSubject<MusicPlayer.Queue.Entry?>(value: nil)

func setCurrentEntrySubject() {
    player.queue.objectWillChange
        .debounce(for: .seconds(0.1), scheduler: RunLoop.main)
        .sink { [weak self] _  in
            guard let self else { return }
            let entry = player.queue.currentEntry
            currentEntrySubject.onNext(entry)
        }.store(in: &cancellable)
}
//...

//MusicPlayerViewModel
musicPlayer.currentEntrySubject
    .asObservable()
    .withUnretained(self)
    .delaySubscription(.milliseconds(1500), scheduler: MainScheduler.instance) //ì²˜ìŒ ì§„ì…í–ˆì„ë•ŒëŠ” trackìœ¼ë¡œ ê·¸ë¦¬ê³ , 1ì´ˆ ë’¤ë¶€í„° êµ¬ë…
    .flatMapLatest { owner, entry in
        owner.fetchCurrentEntryTrackObservable(entry: entry)
    }
    .subscribe(with: self) { owner, track in
        owner.trackSubject.onNext(track)
    }.disposed(by: disposeBag)

//Taskê°€ ë§ˆì¹œ ê²°ê³¼ë¬¼ì„ Observableë¡œ ë³€í™˜í•´ ì‚¬ìš©
func fetchCurrentEntryTrackObservable(entry: MusicPlayer.Queue.Entry?) -> Observable<Track?> {
    return Observable.create { observer in
        Task { [weak self] in
            guard let self else { return }
            do {
                guard let song = try await musicRepository.requestSearchSongIDCatalog(id: entry?.item?.id) else { return }
                let track = Track.song(song)
                observer.onNext(track)
                observer.onCompleted()
            } catch {
                observer.onError(error)
            }
        }
        return Disposables.create()
    }
}
```

</div>
<br>
